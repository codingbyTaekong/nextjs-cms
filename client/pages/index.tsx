import type { NextPage } from 'next'
import Head from 'next/head'
import Link from 'next/link'
import styles from '../styles/public/index.page.module.css'
import GNB from '../components/public/GNB';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faSearch } from '@fortawesome/pro-regular-svg-icons';
import { faPlus } from '@fortawesome/pro-solid-svg-icons';
import React, { useCallback, useEffect, useRef, useState } from 'react';
import { Rate } from 'antd';
import { GetServerSideProps } from 'next'
import axios from '../api/axios';
import GymCard from '../components/public/GymCard';
import {GymData} from '../types/type'
import { useRouter } from 'next/router';
import { useDispatch } from "react-redux";
import {setUserInfo, ActionSetUserInfo} from '../redux/UserInfo'
// import API from '../util/API'
interface Props {
    recent_gyms : Array<GymData>
}

interface ActiveGym {
    clicked : boolean,
    data : GymData
}

const Home : NextPage<Props> = ({recent_gyms}) => {
    console.log(recent_gyms)
    // ë“œë˜ê·¸ ê´€ë ¨ state
    const dispatch = useDispatch();
    const SetUserInfo = ({user_id, user_nickname, rule, access_token} :ActionSetUserInfo) => dispatch(setUserInfo({user_id, user_nickname, rule, access_token}));
    
    const [isDrag, setIsDrag] = useState(false);
    const [startX, setStartX] = useState(0);
    const [movedX, setMovedX] = useState(0);
    const recentContainerRef = useRef<HTMLUListElement>(null);



    // ìƒì„¸ë³´ê¸° ê´€ë ¨ state
    const [isActiveGym, setIsActiveGym] = useState<ActiveGym | null>(null);
    /**
     * ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
     * @param e 
     * @param gym  
     */
    const clickCardHandler = (e: React.MouseEvent<HTMLLIElement>, gym : GymData) => {
        e.preventDefault();
        setIsActiveGym({
            ...isActiveGym,
            clicked : true,
            data : gym
        })
    }
    
    /**
     * ì¹´ë“œ ë‹«ê¸° í•¸ë“¤ëŸ¬
     */
    const removeCardHandler = () => {
        setIsActiveGym(null)
    }

    /**
     * ë“œë˜ê·¸ê°€ ì‹œì‘ í–ˆì„ ë•Œ í•¸ë“¤ëŸ¬
     * @param e 
     */
    const mouseDonwScrollHandler = (e : React.MouseEvent<HTMLUListElement>) => {
        if (recentContainerRef.current && recentContainerRef.current.scrollWidth >= 1070) {
            e.preventDefault();
            setIsDrag(true);
            setStartX(e.pageX);
        }
    }
    /**
     * ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ í•¸ë“¤ëŸ¬
     * @param e 
     */
    const mouseMoveScrollHandler = (e : React.MouseEvent<HTMLUListElement>) => {
        if (isDrag) {
            setMovedX(e.pageX - startX)
        }
    }
    /**
     * ë“œë˜ê·¸ ì·¨ì†Œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
     * @param e 
     */
    const mouseUpScrollHandler = (e : React.MouseEvent<HTMLUListElement>) => {
        if (isDrag) {
            setStartX(0);
            setIsDrag(false);
        }
    }
    /**
     * ë“œë˜ê·¸ ìƒì• ì£¼ê¸°
     */
    useEffect(()=> {
        if (isDrag) {
            // console.log("ì‹¤ì œë¡œ ì›€ì§ì¸ ì¢Œí‘œ", movedX);
            if (recentContainerRef.current) {
                const sum = recentContainerRef.current.scrollLeft + movedX / 50 * -1
                // console.log("ê³„ì‚°í•œ ê²°ê³¼ : ",sum)
                recentContainerRef.current.scrollLeft = sum
            }
        }
    }, [isDrag, movedX])

    useEffect(()=> {
        axios.post(`${process.env.NEXT_PUBLIC_API_URL}/api/auth/refresh`).then(res=> {
            // ë¡œê·¸ì¸ ì²˜ë¦¬
            if (res.data.callback === 200) {
                const accessToken = res.data.token;
                const {id, nickname, rule} = res.data.user
                axios.defaults.headers.common["Authorization"] = `Bearer ${accessToken}`;
                SetUserInfo({
                    user_id : id,
                    user_nickname : nickname,
                    rule,
                    access_token : accessToken,
                })
            }
        })
    },[])


    // ë¦¬ë·°ì‘ì„± í˜ì´ì§€
    // const [isActiveReviewPage, setIsActiveReviewPage] = useState(false);

    // const onClickNewReviewHandler = useCallback(()=> {
    //     setIsActiveReviewPage(!isActiveReviewPage);
    // }, [isActiveReviewPage])
    return (
        <>
            <Head>
                <title>íˆ¬ì–´ë¦¬ìŠ¤íŠ¸</title>
                <meta name="description" content="Generated by create next app" />
            </Head>
            <GNB></GNB>
            <main className={styles.main}>
                <section className={styles.visualSectionContainer}>
                    <h1 className={styles.visualTitle}>Climberë¥¼ ìœ„í•œ ê³µê°„.&nbsp;&nbsp;<b>í´ë¼ì´ë§¥ìŠ¤</b></h1>
                    {/* <h1 className={styles.visualTitle}>Tourlistë¥¼ ìœ„í•œ ê³µê°„.&nbsp;&nbsp;<b>ê°€ìƒì „ì‹œê´€</b></h1> */}
                    <div className={styles.searchContainer}>
                        <input type="text" name="" placeholder='í´ë¼ì´ë°ì¥ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”'/>
                        {/* <input type="text" name="" placeholder='ì „ì‹œê´€ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”'/> */}
                        <button>
                            <FontAwesomeIcon icon={faSearch} />
                        </button>
                    </div>
                </section>
                <section className={styles.recentClimbGymListContainer}>
                    {/* <h1>ìµœê·¼ ëœ¨ê³  ìˆëŠ” ì „ì‹œê´€</h1> */}
                    <h1>ë”°ëˆë”°ëˆí•œ ë¦¬ë·°</h1>
                    <ul className={styles.recentClimbGymList} 
                        ref={recentContainerRef} 
                        onMouseDown={mouseDonwScrollHandler} 
                        onMouseMove={mouseMoveScrollHandler} 
                        onMouseUp={mouseUpScrollHandler}
                        onMouseLeave={mouseUpScrollHandler}>

                        {recent_gyms.map((gym, i) => {
                            // console.log(new Date(gym.reviews[0].created_at))
                            // const recent_date = new Date(gym.reviews[0].created_at).getTime();
                            // const now = new Date().getTime();
                            // console.log(now - recent_date);
                            // const elapsedMSec = now - recent_date
                            // // ì´ˆ
                            // const elapsedSec = elapsedMSec / 1000;
                            // // ë¶„
                            // const elapsedMin = elapsedMSec / 1000 / 60;
                            // // ì‹œ
                            // const elapsedHour = elapsedMSec / 1000 / 60 / 60;
                            // // ë‚ ì§œ
                            // const elapsedDay = elapsedMSec / 1000 / 60 / 60 / 24;
                            // console.log(
                            //     `
                            //         ì´ˆ : ${elapsedSec}
                            //         ë¶„ : ${elapsedMin}
                            //         ì‹œ : ${elapsedHour}
                            //         ì¼ : ${elapsedDay}
                            //     `
                            // )
                            return (
                                <li key={i} className={styles.recentCard} onClick={(e) => clickCardHandler(e, gym)}>
                                    <h1>{gym.gym_name}</h1>
                                    <p>{gym.gym_address}</p>
                                    <div className={styles.reviewContainer}>
                                        <h2>ìµœê·¼ í›„ê¸°</h2>
                                        <ul>
                                            {gym.reviews.map((review, j)=>{
                                                return <li key={j}>{review.review_text}</li>
                                            })}
                                        </ul>
                                        <div className={styles.rateContainer}>
                                            <Rate disabled defaultValue={Number(gym.average_rate)} />
                                            <p>
                                                <span className={styles.totalRate}>{gym.average_rate}&nbsp;</span>
                                                <span className={styles.maxRate}>/5</span>
                                            </p>
                                        </div>
                                    </div>
                                </li>
                            )
                        })}
                        {recent_gyms.length < 5 && <>
                            <li className={styles.emptysetCard}>
                                <h3>ìµœê·¼ ì˜¬ë¼ì˜¨ ë¦¬ë·°ê°€ ì—†ì–´ìš”ğŸ¥º</h3>
                                <div className={styles.circle}>
                                    <FontAwesomeIcon icon={faPlus} />
                                </div>
                                <span className={styles.pleaseReview}></span>
                            </li>
                        </>}
                    </ul>
                </section>
                {isActiveGym?.clicked && <GymCard gym={isActiveGym.data} onRemove={removeCardHandler} />}
            </main>
        </>

    )
}

export const getServerSideProps : GetServerSideProps = async (context) => {
    const recent_gyms = await (await axios.get(`${process.env.NEXT_PUBLIC_API_URL}/gym/recent_reviews`)).data.context;
    return {
        props : {
            recent_gyms
        }
    }
}

export default Home
